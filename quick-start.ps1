# EDC NetSupervisor - Quick Start Script for Windows PowerShell
# One-command installation and startup for Windows

param(
    [Parameter(Position=0)]
    [ValidateSet("install", "start", "stop", "status", "update", "uninstall", "help", "")]
    [string]$Command = "install",
    
    [string]$InstallDir = "edc-netsupervisor",
    [string]$Domain = "localhost",
    [int]$Port = 80,
    [ValidateSet("full", "development", "production")]
    [string]$InstallType = "full"
)

# Requires PowerShell 5.1 or later
#Requires -Version 5.1

# Configuration
$Script:RepoUrl = "https://github.com/your-org/edc-netsupervisor.git"
$Script:DefaultDomain = "localhost"
$Script:DefaultPort = 80

# Colors for output (PowerShell compatible)
function Write-ColorOutput {
    param(
        [string]$Message,
        [ValidateSet("Red", "Green", "Yellow", "Blue", "Magenta", "Cyan", "White")]
        [string]$ForegroundColor = "White"
    )
    Write-Host $Message -ForegroundColor $ForegroundColor
}

function Write-Log { 
    param([string]$Message)
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-ColorOutput "[$timestamp] $Message" -ForegroundColor Green 
}

function Write-Warning { 
    param([string]$Message)
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-ColorOutput "[$timestamp] WARNING: $Message" -ForegroundColor Yellow 
}

function Write-Error { 
    param([string]$Message)
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-ColorOutput "[$timestamp] ERROR: $Message" -ForegroundColor Red 
}

function Write-Info { 
    param([string]$Message)
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-ColorOutput "[$timestamp] INFO: $Message" -ForegroundColor Blue 
}

function Write-Success { 
    param([string]$Message)
    $timestamp = Get-Date -Format "HH:mm:ss"
    Write-ColorOutput "[$timestamp] SUCCESS: $Message" -ForegroundColor Green 
}

# Show banner
function Show-Banner {
    Clear-Host
    Write-ColorOutput @"
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë         ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë   
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë         ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë   
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   
                                                           
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
"@ -ForegroundColor Magenta

    Write-ColorOutput "        Plateforme de supervision r√©seau avanc√©e" -ForegroundColor Cyan
    Write-ColorOutput "              Script d'installation PowerShell" -ForegroundColor Cyan
    Write-Host ""
    Write-ColorOutput "üöÄ Pr√©parez votre plateforme de supervision r√©seau en quelques minutes !" -ForegroundColor Green
    Write-Host ""
}

# Check prerequisites
function Test-Prerequisites {
    Write-Log "V√©rification des pr√©requis syst√®me..."
    
    $missingDeps = @()
    
    # Check for required commands
    $requiredCommands = @("git", "docker", "docker-compose")
    
    foreach ($cmd in $requiredCommands) {
        if (!(Get-Command $cmd -ErrorAction SilentlyContinue)) {
            $missingDeps += $cmd
        }
    }
    
    if ($missingDeps.Count -gt 0) {
        Write-Error "D√©pendances manquantes : $($missingDeps -join ', ')"
        Write-Host ""
        Write-Info "Veuillez installer les d√©pendances manquantes :"
        Write-Host ""
        Write-Host "  Windows :"
        Write-Host "    Git : https://git-scm.com/download/win"
        Write-Host "    Docker Desktop : https://www.docker.com/products/docker-desktop"
        Write-Host ""
        throw "D√©pendances manquantes"
    }
    
    # Check Docker daemon
    try {
        docker info 2>$null | Out-Null
        if ($LASTEXITCODE -ne 0) {
            throw "Docker daemon not running"
        }
    }
    catch {
        Write-Error "Docker daemon n'est pas en cours d'ex√©cution"
        Write-Info "Veuillez d√©marrer Docker Desktop et r√©essayer"
        throw "Docker non disponible"
    }
    
    Write-Success "Tous les pr√©requis sont satisfaits"
}

# Get user preferences  
function Get-UserPreferences {
    Write-ColorOutput "üìã Configuration" -ForegroundColor Cyan
    Write-Host ""
    
    # Installation directory
    $userInstallDir = Read-Host "üìÅ R√©pertoire d'installation [$InstallDir]"
    if ($userInstallDir) {
        $Script:InstallDir = $userInstallDir
    }
    
    # Domain/hostname
    $userDomain = Read-Host "üåê Domaine/hostname [$Domain]"
    if ($userDomain) {
        $Script:Domain = $userDomain
    }
    
    # Port
    $userPort = Read-Host "üîå Port HTTP [$Port]"
    if ($userPort -and $userPort -as [int]) {
        $Script:Port = [int]$userPort
    }
    
    # Installation type
    Write-Host ""
    Write-Host "üîß Type d'installation :"
    Write-Host "  1) Installation compl√®te (Recommand√©e)"
    Write-Host "  2) Mode d√©veloppement"
    Write-Host "  3) D√©ploiement production"
    $installChoice = Read-Host "S√©lectionnez une option [1]"
    
    switch ($installChoice) {
        "2" { $Script:InstallType = "development" }
        "3" { $Script:InstallType = "production" }
        default { $Script:InstallType = "full" }
    }
    
    Write-Host ""
    Write-Success "Configuration termin√©e"
    Write-Host "  üìÅ R√©pertoire : $InstallDir"
    Write-Host "  üåê Domaine : $Domain"
    Write-Host "  üîå Port : $Port"
    Write-Host "  üîß Type : $InstallType"
    Write-Host ""
}

# Download source code
function Get-SourceCode {
    Write-Log "T√©l√©chargement du code source EDC NetSupervisor..."
    
    if (Test-Path $InstallDir) {
        Write-Warning "Le r√©pertoire $InstallDir existe d√©j√†"
        $confirm = Read-Host "Voulez-vous le supprimer et continuer ? [y/N]"
        if ($confirm -notmatch '^[Yy]$') {
            Write-Error "Installation annul√©e"
            exit 1
        }
        Remove-Item $InstallDir -Recurse -Force
    }
    
    try {
        git clone $RepoUrl $InstallDir
        if ($LASTEXITCODE -ne 0) {
            throw "Git clone failed"
        }
    }
    catch {
        Write-Error "√âchec du clonage du repository"
        Write-Info "Vous pouvez aussi t√©l√©charger et extraire le code source manuellement"
        throw "Download failed"
    }
    
    Set-Location $InstallDir
    Write-Success "Code source t√©l√©charg√© avec succ√®s"
}

# Generate configuration
function New-Configuration {
    Write-Log "G√©n√©ration des fichiers de configuration..."
    
    # Generate secure secrets
    $jwtSecret = [Convert]::ToBase64String((1..64 | ForEach-Object { Get-Random -Maximum 256 }))
    $encryptionKey = -join ((1..32) | ForEach-Object { '{0:X}' -f (Get-Random -Maximum 16) })
    $encryptionIV = -join ((1..16) | ForEach-Object { '{0:X}' -f (Get-Random -Maximum 16) })
    $dbPassword = -join ((1..16) | ForEach-Object { [char](Get-Random -Minimum 65 -Maximum 91) })
    $adminPassword = -join ((1..12) | ForEach-Object { [char](Get-Random -Minimum 65 -Maximum 91) })
    
    # Create .env file
    $envContent = @"
# EDC NetSupervisor Configuration
# G√©n√©r√© le $(Get-Date)

# Application
NODE_ENV=$InstallType
PORT=5000
CLIENT_URL=http://${Domain}:${Port}

# Database
MONGODB_URI=mongodb://admin:${dbPassword}@mongodb:27017/edc_netsupervisor?authSource=admin
MONGO_USERNAME=admin
MONGO_PASSWORD=$dbPassword

# Redis
REDIS_URL=redis://redis:6379
REDIS_PASSWORD=

# Security
JWT_SECRET=$jwtSecret
REFRESH_TOKEN_SECRET=${jwtSecret}refresh
ENCRYPTION_KEY=$encryptionKey
ENCRYPTION_IV=$encryptionIV

# Admin Account
ADMIN_EMAIL=admin@edc-netsupervisor.local
ADMIN_PASSWORD=$adminPassword

# Features
ENABLE_METRICS=true
ENABLE_SWAGGER=true
LOG_LEVEL=info

# Monitoring
GRAFANA_USER=admin
GRAFANA_PASSWORD=admin

# Backup
BACKUP_ENABLED=true
BACKUP_INTERVAL=daily
BACKUP_RETENTION_DAYS=30
"@

    $envContent | Out-File -FilePath ".env" -Encoding UTF8
    
    # Update docker-compose ports if needed
    if ($Port -ne 80) {
        $dockerComposeContent = Get-Content "docker-compose.yml" -Raw
        $dockerComposeContent = $dockerComposeContent -replace "80:80", "${Port}:80"
        $dockerComposeContent | Out-File -FilePath "docker-compose.yml" -Encoding UTF8
    }
    
    Write-Success "Fichiers de configuration g√©n√©r√©s"
    Write-Info "Identifiants administrateur :"
    Write-Host "  üìß Email : admin@edc-netsupervisor.local"
    Write-Host "  üîê Mot de passe : $adminPassword"
    Write-Host ""
    Write-Warning "Veuillez sauvegarder ces identifiants - ils ne seront plus affich√©s !"
    Write-Host ""
    
    # Save credentials to file for user
    @"
EDC NetSupervisor - Identifiants de connexion
============================================
Email: admin@edc-netsupervisor.local
Mot de passe: $adminPassword
G√©n√©r√© le: $(Get-Date)

IMPORTANT: Changez ce mot de passe apr√®s la premi√®re connexion !
"@ | Out-File -FilePath "IDENTIFIANTS.txt" -Encoding UTF8
}

# Setup SSL certificates
function New-SSLCertificates {
    Write-Log "Configuration des certificats SSL..."
    
    New-Item -ItemType Directory -Path "ssl" -Force | Out-Null
    
    # Check if OpenSSL is available
    if (Get-Command openssl -ErrorAction SilentlyContinue) {
        # Generate self-signed certificate with OpenSSL
        & openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ssl/key.pem -out ssl/cert.pem -subj "/C=FR/ST=State/L=City/O=EDC NetSupervisor/CN=$Domain" 2>$null
        Write-Success "Certificats SSL cr√©√©s (auto-sign√©s pour d√©veloppement)"
    }
    else {
        Write-Warning "OpenSSL non trouv√© - cr√©ation de certificats factices"
        "# Certificate placeholder" | Out-File -FilePath "ssl/cert.pem" -Encoding UTF8
        "# Key placeholder" | Out-File -FilePath "ssl/key.pem" -Encoding UTF8
    }
}

# Create necessary directories
function New-Directories {
    Write-Log "Cr√©ation des r√©pertoires n√©cessaires..."
    
    $directories = @("logs", "uploads", "backups", "ssl", "nginx/conf.d")
    
    foreach ($dir in $directories) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
        # Create .gitkeep files
        "" | Out-File -FilePath "$dir/.gitkeep" -Encoding UTF8
    }
    
    Write-Success "R√©pertoires cr√©√©s"
}

# Install and start services
function Start-Services {
    Write-Log "D√©marrage des services EDC NetSupervisor..."
    
    # Pull images and build
    Write-Info "T√©l√©chargement des images Docker (peut prendre quelques minutes)..."
    & docker-compose pull --ignore-pull-failures
    
    Write-Info "Construction des conteneurs d'application..."
    & docker-compose build
    
    if ($LASTEXITCODE -ne 0) {
        Write-Error "√âchec de la construction Docker"
        throw "Docker build failed"
    }
    
    # Start services
    Write-Info "D√©marrage de tous les services..."
    & docker-compose up -d
    
    if ($LASTEXITCODE -ne 0) {
        Write-Error "√âchec du d√©marrage des services"
        throw "Service startup failed"
    }
    
    # Wait for services to be ready
    Write-Log "Attente du d√©marrage des services..."
    $timeout = 120
    $elapsed = 0
    
    do {
        Start-Sleep -Seconds 5
        $elapsed += 5
        Write-Host "." -NoNewline
        
        try {
            $response = Invoke-WebRequest -Uri "http://localhost:5000/api/health" -TimeoutSec 2 -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
                break
            }
        }
        catch {
            # Continue waiting
        }
    } while ($elapsed -lt $timeout)
    
    Write-Host ""
    
    if ($elapsed -ge $timeout) {
        Write-Error "Les services n'ont pas d√©marr√© dans les $timeout secondes"
        Write-Info "V√©rifiez les logs avec : docker-compose logs"
        throw "Service startup timeout"
    }
    
    Write-Success "Tous les services sont en cours d'ex√©cution !"
}

# Run initial setup
function Initialize-Setup {
    Write-Log "Ex√©cution de la configuration initiale..."
    
    # Initialize database
    Write-Info "Initialisation de la base de donn√©es..."
    try {
        if (Test-Path "scripts/mongo-init.js") {
            & docker-compose exec -T mongodb mongosh edc_netsupervisor --file /scripts/mongo-init.js
        }
    }
    catch {
        Write-Warning "L'initialisation de la base de donn√©es peut avoir √©chou√© - ce n'est g√©n√©ralement pas critique"
    }
    
    # Wait a bit for everything to settle
    Start-Sleep -Seconds 10
    
    Write-Success "Configuration initiale termin√©e"
}

# Verify installation
function Test-Installation {
    Write-Log "V√©rification de l'installation..."
    
    $services = @("app", "mongodb", "redis", "nginx")
    $allHealthy = $true
    
    foreach ($service in $services) {
        try {
            $status = & docker-compose ps $service
            if ($status -match "Up") {
                Write-Success "‚úÖ $service est en cours d'ex√©cution"
            }
            else {
                Write-Error "‚ùå $service n'est pas en cours d'ex√©cution"
                $allHealthy = $false
            }
        }
        catch {
            Write-Error "‚ùå Impossible de v√©rifier le statut de $service"
            $allHealthy = $false
        }
    }
    
    # Test API endpoint
    try {
        $response = Invoke-WebRequest -Uri "http://localhost:5000/api/health" -TimeoutSec 5
        if ($response.StatusCode -eq 200) {
            Write-Success "‚úÖ L'API r√©pond"
        }
        else {
            Write-Error "‚ùå L'API ne r√©pond pas correctement"
            $allHealthy = $false
        }
    }
    catch {
        Write-Error "‚ùå L'API ne r√©pond pas"
        $allHealthy = $false
    }
    
    # Test web interface
    try {
        $response = Invoke-WebRequest -Uri "http://localhost:$Port" -TimeoutSec 5
        if ($response.StatusCode -eq 200) {
            Write-Success "‚úÖ L'interface web est accessible"
        }
        else {
            Write-Error "‚ùå L'interface web n'est pas accessible"
            $allHealthy = $false
        }
    }
    catch {
        Write-Error "‚ùå L'interface web n'est pas accessible"
        $allHealthy = $false
    }
    
    if ($allHealthy) {
        Write-Success "üéâ V√©rification de l'installation r√©ussie !"
    }
    else {
        Write-Error "‚ö†Ô∏è Certains services peuvent ne pas fonctionner correctement"
        Write-Info "V√©rifiez les logs avec : docker-compose logs"
    }
}

# Show completion message
function Show-Completion {
    Write-Host ""
    Write-ColorOutput "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
    Write-ColorOutput "‚ïë                    üéâ INSTALLATION TERMIN√âE ! üéâ            ‚ïë" -ForegroundColor Green  
    Write-ColorOutput "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
    Write-Host ""
    Write-ColorOutput "üåê Votre EDC NetSupervisor est maintenant accessible √† :" -ForegroundColor Cyan
    Write-ColorOutput "   üëâ http://${Domain}:${Port}" -ForegroundColor White
    Write-Host ""
    Write-ColorOutput "üìä Tableaux de bord de monitoring :" -ForegroundColor Cyan
    Write-ColorOutput "   üìà Grafana : http://${Domain}:3001 (admin/admin)" -ForegroundColor White
    Write-ColorOutput "   üîç Prometheus : http://${Domain}:9090" -ForegroundColor White
    Write-Host ""
    Write-ColorOutput "üîß Commandes de gestion :" -ForegroundColor Cyan
    Write-ColorOutput "   üê≥ Voir les logs : " -ForegroundColor White -NoNewline
    Write-ColorOutput "docker-compose logs -f" -ForegroundColor Yellow
    Write-ColorOutput "   ‚èπÔ∏è  Arr√™ter services : " -ForegroundColor White -NoNewline
    Write-ColorOutput "docker-compose down" -ForegroundColor Yellow
    Write-ColorOutput "   üîÑ Red√©marrer : " -ForegroundColor White -NoNewline
    Write-ColorOutput "docker-compose restart" -ForegroundColor Yellow
    Write-Host ""
    Write-ColorOutput "üìö Prochaines √©tapes :" -ForegroundColor Cyan
    Write-ColorOutput "   1Ô∏è‚É£  Connectez-vous avec vos identifiants admin" -ForegroundColor White
    Write-ColorOutput "   2Ô∏è‚É£  Configurez vos sous-r√©seaux" -ForegroundColor White
    Write-ColorOutput "   3Ô∏è‚É£  Lancez votre premi√®re d√©couverte r√©seau" -ForegroundColor White
    Write-ColorOutput "   4Ô∏è‚É£  Explorez la visualisation de topologie" -ForegroundColor White
    Write-Host ""
    Write-ColorOutput "‚ö†Ô∏è  Notes de s√©curit√© importantes :" -ForegroundColor Yellow
    Write-ColorOutput "   üîê Changez le mot de passe admin apr√®s la premi√®re connexion" -ForegroundColor White
    Write-ColorOutput "   üîí Remplacez les certificats SSL auto-sign√©s en production" -ForegroundColor White
    Write-ColorOutput "   üõ°Ô∏è  R√©visez les param√®tres de s√©curit√© dans le panneau admin" -ForegroundColor White
    Write-Host ""
    Write-ColorOutput "üìÑ Les identifiants sont sauvegard√©s dans : IDENTIFIANTS.txt" -ForegroundColor Green
    Write-Host ""
    Write-ColorOutput "Merci d'utiliser EDC NetSupervisor ! üöÄ" -ForegroundColor Magenta
    Write-Host ""
}

# Main installation function
function Install-EDCNetSupervisor {
    try {
        Show-Banner
        
        # Interactive installation
        Write-ColorOutput "üî• Bienvenue dans l'installation rapide d'EDC NetSupervisor !" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "Ce script va installer et configurer EDC NetSupervisor sur votre syst√®me."
        Write-Host "Le processus complet devrait prendre 5-10 minutes selon votre connexion internet."
        Write-Host ""
        $proceed = Read-Host "Pr√™t √† continuer ? [Y/n]"
        
        if ($proceed -match '^[Nn]$') {
            Write-Info "Installation annul√©e par l'utilisateur"
            exit 0
        }
        
        Write-Host ""
        
        # Run installation steps
        Test-Prerequisites
        Get-UserPreferences
        Get-SourceCode
        New-Directories
        New-Configuration
        New-SSLCertificates
        Start-Services
        Initialize-Setup
        Test-Installation
        Show-Completion
    }
    catch {
        Write-Error "Installation √©chou√©e : $($_.Exception.Message)"
        Write-Info "Consultez les logs pour plus de d√©tails"
        exit 1
    }
}

# Command handlers
function Start-Application {
    if (!(Test-Path $InstallDir)) {
        Write-Error "Installation EDC NetSupervisor non trouv√©e"
        exit 1
    }
    Set-Location $InstallDir
    Write-Log "D√©marrage d'EDC NetSupervisor..."
    & docker-compose up -d
    Write-Success "Services d√©marr√©s"
}

function Stop-Application {
    if (!(Test-Path $InstallDir)) {
        Write-Error "Installation EDC NetSupervisor non trouv√©e"
        exit 1
    }
    Set-Location $InstallDir
    Write-Log "Arr√™t d'EDC NetSupervisor..."
    & docker-compose down
    Write-Success "Services arr√™t√©s"
}

function Get-ApplicationStatus {
    if (!(Test-Path $InstallDir)) {
        Write-Error "Installation EDC NetSupervisor non trouv√©e"
        exit 1
    }
    Set-Location $InstallDir
    & docker-compose ps
}

function Update-Application {
    if (!(Test-Path $InstallDir)) {
        Write-Error "Installation EDC NetSupervisor non trouv√©e"
        exit 1
    }
    Set-Location $InstallDir
    Write-Log "Mise √† jour d'EDC NetSupervisor..."
    & git pull origin main
    & docker-compose build
    & docker-compose up -d
    Write-Success "Mise √† jour termin√©e"
}

function Uninstall-Application {
    if (!(Test-Path $InstallDir)) {
        Write-Error "Installation EDC NetSupervisor non trouv√©e"
        exit 1
    }
    $confirm = Read-Host "√ätes-vous s√ªr de vouloir d√©sinstaller EDC NetSupervisor ? [y/N]"
    if ($confirm -match '^[Yy]$') {
        Set-Location $InstallDir
        & docker-compose down -v
        Set-Location ..
        Remove-Item $InstallDir -Recurse -Force
        Write-Success "EDC NetSupervisor d√©sinstall√©"
    }
}

function Show-Help {
    Write-Host "EDC NetSupervisor - Script d'installation rapide PowerShell"
    Write-Host ""
    Write-Host "Usage: .\quick-start.ps1 [commande]"
    Write-Host ""
    Write-Host "Commandes:"
    Write-Host "  install    - Installer EDC NetSupervisor (par d√©faut)"
    Write-Host "  start      - D√©marrer les services"
    Write-Host "  stop       - Arr√™ter les services"
    Write-Host "  status     - Afficher le statut des services"
    Write-Host "  update     - Mettre √† jour vers la derni√®re version"
    Write-Host "  uninstall  - Supprimer EDC NetSupervisor"
    Write-Host "  help       - Afficher cette aide"
    Write-Host ""
    Write-Host "Exemples:"
    Write-Host "  .\quick-start.ps1"
    Write-Host "  .\quick-start.ps1 install"
    Write-Host "  .\quick-start.ps1 start"
}

# Main script execution
switch ($Command.ToLower()) {
    "" { Install-EDCNetSupervisor }
    "install" { Install-EDCNetSupervisor }
    "start" { Start-Application }
    "stop" { Stop-Application }
    "status" { Get-ApplicationStatus }
    "update" { Update-Application }
    "uninstall" { Uninstall-Application }
    "help" { Show-Help }
    default {
        Write-Error "Commande inconnue : $Command"
        Write-Host "Utilisez '.\quick-start.ps1 help' pour l'aide"
        exit 1
    }
}